services:
    runner:
        container_name: ${USER}_maskbench_dev
        build: .                
        env_file: 
          - .env
        depends_on:
          - openpose
        volumes:
          - ./src:/src          
          - ./poetry.lock:/poetry.lock 
          - ./pyproject.toml:/pyproject.toml
          - ./config:/config
          - ${MASKBENCH_DATASET_DIR}:/datasets  
          - ${MASKBENCH_OUTPUT_DIR}:/output
          - ${MASKBENCH_WEIGHTS_DIR}:/weights
        tty: true               # Keep the container running interactively
        stdin_open: true
        deploy:
          resources:
            reservations:
              devices:
                - driver: nvidia
                  count: 1
                  capabilities: [ gpu ]
        devices:
            - /dev/nvidia1:/dev/nvidia0
            - /dev/nvidiactl:/dev/nvidiactl
            - /dev/nvidia-uvm:/dev/nvidia-uvm
            - /dev/nvidia-uvm-tools:/dev/nvidia-uvm-tools


    openpose:
      image: ghcr.io/maskanyone/maskanyone/openpose:0.3.0
      restart: on-failure
      environment:
        OPENPOSE_MODEL_DIR: "/workspace/openpose/models"
      deploy:
        resources:
          reservations:
            devices:
              - driver: nvidia
                count: 1
                capabilities: [ gpu ]
      devices:
        - /dev/nvidia1:/dev/nvidia0
        - /dev/nvidiactl:/dev/nvidiactl
        - /dev/nvidia-uvm:/dev/nvidia-uvm
        - /dev/nvidia-uvm-tools:/dev/nvidia-uvm-tools
