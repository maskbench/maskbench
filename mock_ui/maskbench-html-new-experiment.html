<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaskBench - New Experiment</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#f5f5f5;color:#000;line-height:1.5}
    
    .icon-box{width:40px;height:40px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;border-radius:8px;flex-shrink:0;transition:all .2s}
    .icon-box-sm{width:32px;height:32px;font-size:14px}
    .icon-box-lg{width:56px;height:56px;font-size:22px}
    .icon-box-outline{background:#fff;color:#000;border:2px solid #e5e5e5}
    .icon-box-outline.active{border-color:#000;background:#000;color:#fff}
    .icon-box-success{background:#e8f5e9;color:#2e7d32}
    .icon-box-gray{background:#e5e5e5;color:#666}
    
    .card{background:#fff;border:1px solid #e5e5e5;transition:all .2s}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;border:none}
    .btn-primary{background:#000;color:#fff}.btn-primary:hover{background:#333}
    .btn-primary:disabled{background:#ccc;cursor:not-allowed}
    .btn-secondary{background:#fff;color:#000;border:2px solid #000}.btn-secondary:hover{background:#000;color:#fff}
    .btn-ghost{background:transparent;color:#666;padding:8px 16px}.btn-ghost:hover{background:#f0f0f0;color:#000}
    .btn-sm{padding:8px 16px;font-size:12px}
    .btn-icon{width:36px;height:36px;padding:0;justify-content:center;border-radius:4px}
    
    .tag{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;font-size:11px;font-weight:600}
    .tag-default{background:#000;color:#fff}
    .tag-success{background:#e8f5e9;color:#2e7d32}
    .tag-info{background:#e3f2fd;color:#1565c0}
    
    .input{width:100%;padding:12px 16px;font-family:inherit;font-size:14px;border:2px solid #e5e5e5;transition:border-color .2s}
    .input:focus{outline:none;border-color:#000}
    .input::placeholder{color:#999}
    
    .select{width:100%;padding:12px 16px;font-family:inherit;font-size:14px;border:2px solid #e5e5e5;background:#fff;cursor:pointer;transition:border-color .2s}
    .select:focus{outline:none;border-color:#000}
    
    .checkbox-card{padding:14px;border:2px solid #e5e5e5;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px}
    .checkbox-card:hover{border-color:#999;background:#fafafa}
    .checkbox-card.selected{border-color:#000;background:#fafafa}
    .checkbox-card input{display:none}
    .checkbox-card .checkmark{width:20px;height:20px;border:2px solid #ccc;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .checkbox-card.selected .checkmark{background:#000;border-color:#000;color:#fff}
    .color-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
    
    .app-header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:#fff;border-bottom:1px solid #e5e5e5}
    .app-logo{font-size:18px;font-weight:700;display:flex;align-items:center;gap:12px}
    .app-nav{display:flex;gap:4px}
    .app-nav a{font-size:13px;color:#666;text-decoration:none;padding:8px 16px;transition:all .2s}
    .app-nav a:hover{background:#f5f5f5;color:#000}
    .app-nav a.active{background:#000;color:#fff}
    
    .app-body{display:flex;min-height:calc(100vh - 65px)}
    .app-sidebar{width:320px;background:#fff;border-right:1px solid #e5e5e5;padding:24px;flex-shrink:0;overflow-y:auto}
    .app-main{flex:1;padding:32px;background:#f5f5f5;overflow-y:auto}
    
    .sidebar-section{margin-bottom:24px}
    .sidebar-section h4{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#666;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .sidebar-section h4 .count{background:#000;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px}
    
    .step-indicator{display:flex;align-items:center;gap:0;margin-bottom:32px;padding:0 16px}
    .step{display:flex;flex-direction:column;align-items:center;flex:1;position:relative}
    .step-dot{width:36px;height:36px;border-radius:50%;background:#e5e5e5;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600;color:#999;transition:all .3s;z-index:1}
    .step.active .step-dot{background:#000;color:#fff}
    .step.completed .step-dot{background:#2e7d32;color:#fff}
    .step-label{font-size:11px;color:#999;margin-top:8px;transition:color .3s}
    .step.active .step-label,.step.completed .step-label{color:#000}
    .step-line{position:absolute;top:18px;left:calc(50% + 18px);width:calc(100% - 36px);height:2px;background:#e5e5e5}
    .step:last-child .step-line{display:none}
    .step.completed .step-line{background:#2e7d32}
    
    .drop-zone{border:2px dashed #ccc;padding:48px;text-align:center;cursor:pointer;transition:all .2s;background:#fafafa}
    .drop-zone:hover,.drop-zone.dragover{border-color:#000;background:#fff}
    .drop-zone.has-files{border-style:solid;border-color:#2e7d32;background:#f1f8e9}
    
    .video-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-top:16px}
    .video-card{background:#fff;border:1px solid #e5e5e5;overflow:hidden;position:relative;transition:all .2s}
    .video-card:hover{border-color:#000;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .video-card .remove-btn{position:absolute;top:8px;right:8px;width:24px;height:24px;background:rgba(0,0,0,.7);color:#fff;border:none;border-radius:50%;cursor:pointer;opacity:0;transition:opacity .2s;display:flex;align-items:center;justify-content:center;font-size:12px}
    .video-card:hover .remove-btn{opacity:1}
    .video-thumb{aspect-ratio:16/9;background:#1a1a1a;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .video-thumb i{color:#666;font-size:24px}
    .video-thumb .duration{position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,.8);color:#fff;font-size:10px;padding:2px 6px;border-radius:2px}
    .video-info{padding:10px}
    .video-name{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .video-meta{font-size:10px;color:#666;margin-top:2px}
    
    .config-summary{background:#fafafa;border:1px solid #e5e5e5;padding:16px;margin-top:16px}
    .config-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e5e5;font-size:13px}
    .config-row:last-child{border-bottom:none}
    .config-row .label{color:#666}
    .config-row .value{font-weight:500}
    
    .cli-panel{background:#1a1a1a;color:#fff;padding:16px;font-family:'SF Mono',Monaco,monospace;font-size:12px;margin-top:24px}
    .cli-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .cli-title{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888}
    .cli-content{background:#000;padding:12px;overflow-x:auto;border-radius:4px}
    .cli-content code{color:#00ff88}
    
    .progress-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .progress-modal.visible{display:flex}
    .progress-card{background:#fff;padding:48px;text-align:center;max-width:400px;width:90%}
    .progress-bar-lg{height:8px;background:#e5e5e5;border-radius:4px;overflow:hidden;margin:24px 0}
    .progress-bar-lg .fill{height:100%;background:#000;transition:width .3s}
    
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .fade-in{animation:fadeIn .4s ease-out}
    .slide-up{animation:slideUp .4s ease-out}
    .pulse{animation:pulse 2s infinite}
    .spin{animation:spin 1s linear infinite}
    
    h1{font-size:24px;font-weight:300}h1 span{font-weight:600}
    h4{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#666}
    .text-sm{font-size:13px}.text-xs{font-size:11px}.text-gray{color:#666}
    .flex{display:flex}.flex-1{flex:1}.items-center{align-items:center}.justify-between{justify-content:space-between}.justify-center{justify-content:center}
    .gap-4{gap:4px}.gap-8{gap:8px}.gap-12{gap:12px}.gap-16{gap:16px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .mb-4{margin-bottom:4px}.mb-8{margin-bottom:8px}.mb-16{margin-bottom:16px}.mb-24{margin-bottom:24px}
    .mt-16{margin-top:16px}
    .p-16{padding:16px}
    .w-full{width:100%}
    .border-b{border-bottom:1px solid #e5e5e5}
  </style>
</head>
<body>

<header class="app-header">
  <div class="flex items-center gap-16">
    <div class="app-logo"><i class="fas fa-chart-bar"></i> MaskBench</div>
    <nav class="app-nav">
      <a href="maskbench-dashboard.html">Dashboard</a>
      <a href="#" class="active">New Experiment</a>
      <a href="maskbench-results.html">Results</a>
      <a href="maskbench-compare.html">Compare</a>
      <a href="maskbench-history.html">History</a>
    </nav>
  </div>
  <div class="flex items-center gap-8">
    <button class="btn btn-ghost btn-sm"><i class="fas fa-book"></i> Docs</button>
    <button class="btn btn-ghost btn-sm"><i class="fas fa-cog"></i></button>
  </div>
</header>

<div class="app-body">
  <!-- Sidebar: Configuration -->
  <aside class="app-sidebar">
    <div class="sidebar-section">
      <h4><i class="fas fa-flask"></i> Experiment Name</h4>
      <input type="text" class="input" id="experimentName" placeholder="My Experiment" value="TED_Gesture_Study">
    </div>

    <div class="sidebar-section">
      <h4><i class="fas fa-database"></i> Dataset Source</h4>
      <select class="select" id="datasetSelect" onchange="handleDatasetChange()">
        <option value="custom">Upload Videos</option>
        <option value="tedkid">TED Kid Video (Demo)</option>
        <option value="tragictalkers">Tragic Talkers (with GT)</option>
      </select>
    </div>

    <div class="sidebar-section">
      <h4><i class="fas fa-robot"></i> Pose Estimators <span class="count" id="estimatorCount">3</span></h4>
      <div class="flex" style="flex-direction:column;gap:8px" id="estimatorList">
        <label class="checkbox-card selected" data-estimator="yolo">
          <input type="checkbox" checked>
          <span class="checkmark"><i class="fas fa-check" style="font-size:12px"></i></span>
          <div class="color-dot" style="background:#000"></div>
          <div class="flex-1">
            <p class="text-sm" style="font-weight:500">YOLOv11-Pose</p>
            <p class="text-xs text-gray">Fast, robust</p>
          </div>
        </label>
        <label class="checkbox-card selected" data-estimator="mediapipe">
          <input type="checkbox" checked>
          <span class="checkmark"><i class="fas fa-check" style="font-size:12px"></i></span>
          <div class="color-dot" style="background:#2196f3"></div>
          <div class="flex-1">
            <p class="text-sm" style="font-weight:500">MediaPipe Pose</p>
            <p class="text-xs text-gray">CPU-friendly</p>
          </div>
        </label>
        <label class="checkbox-card selected" data-estimator="openpose">
          <input type="checkbox" checked>
          <span class="checkmark"><i class="fas fa-check" style="font-size:12px"></i></span>
          <div class="color-dot" style="background:#ff9800"></div>
          <div class="flex-1">
            <p class="text-sm" style="font-weight:500">OpenPose</p>
            <p class="text-xs text-gray">Multi-person</p>
          </div>
        </label>
        <label class="checkbox-card" data-estimator="maskanyone-mp">
          <input type="checkbox">
          <span class="checkmark"><i class="fas fa-check" style="font-size:12px"></i></span>
          <div class="color-dot" style="background:#9c27b0"></div>
          <div class="flex-1">
            <p class="text-sm" style="font-weight:500">MaskAnyone-MediaPipe</p>
            <p class="text-xs text-gray">Smoothest output</p>
          </div>
        </label>
        <label class="checkbox-card" data-estimator="maskanyone-op">
          <input type="checkbox">
          <span class="checkmark"><i class="fas fa-check" style="font-size:12px"></i></span>
          <div class="color-dot" style="background:#e91e63"></div>
          <div class="flex-1">
            <p class="text-sm" style="font-weight:500">MaskAnyone-OpenPose</p>
            <p class="text-xs text-gray">Multi-person smooth</p>
          </div>
        </label>
      </div>
    </div>

    <div class="sidebar-section">
      <h4><i class="fas fa-ruler"></i> Metrics</h4>
      <div class="grid-2">
        <label class="checkbox-card selected" style="padding:10px">
          <input type="checkbox" checked>
          <span class="checkmark" style="width:16px;height:16px"><i class="fas fa-check" style="font-size:10px"></i></span>
          <span class="text-sm">Velocity</span>
        </label>
        <label class="checkbox-card selected" style="padding:10px">
          <input type="checkbox" checked>
          <span class="checkmark" style="width:16px;height:16px"><i class="fas fa-check" style="font-size:10px"></i></span>
          <span class="text-sm">Acceleration</span>
        </label>
        <label class="checkbox-card selected" style="padding:10px">
          <input type="checkbox" checked>
          <span class="checkmark" style="width:16px;height:16px"><i class="fas fa-check" style="font-size:10px"></i></span>
          <span class="text-sm">Jerk</span>
        </label>
        <label class="checkbox-card" style="padding:10px" id="pckMetric">
          <input type="checkbox">
          <span class="checkmark" style="width:16px;height:16px"><i class="fas fa-check" style="font-size:10px"></i></span>
          <span class="text-sm">PCK</span>
        </label>
        <label class="checkbox-card" style="padding:10px" id="rmseMetric">
          <input type="checkbox">
          <span class="checkmark" style="width:16px;height:16px"><i class="fas fa-check" style="font-size:10px"></i></span>
          <span class="text-sm">RMSE</span>
        </label>
      </div>
      <p class="text-xs text-gray mt-16" id="gtNote"><i class="fas fa-info-circle"></i> PCK/RMSE require ground truth data</p>
    </div>

    <div class="sidebar-section">
      <h4><i class="fas fa-sliders-h"></i> Advanced Options</h4>
      <details style="cursor:pointer">
        <summary class="text-sm" style="padding:8px 0">Confidence thresholds, output format...</summary>
        <div style="padding:12px 0">
          <label class="text-xs text-gray">YOLO Confidence</label>
          <input type="range" min="0" max="100" value="30" class="w-full" style="margin:8px 0">
          <label class="text-xs text-gray">MediaPipe Confidence</label>
          <input type="range" min="0" max="100" value="30" class="w-full" style="margin:8px 0">
          <label class="checkbox-card selected" style="padding:10px;margin-top:8px">
            <input type="checkbox" checked>
            <span class="checkmark" style="width:16px;height:16px"><i class="fas fa-check" style="font-size:10px"></i></span>
            <span class="text-sm">Save in COCO format</span>
          </label>
        </div>
      </details>
    </div>

    <button class="btn btn-primary w-full" id="runBtn" onclick="runExperiment()">
      <i class="fas fa-play"></i> Run Experiment
    </button>
  </aside>

  <!-- Main: Upload Area -->
  <main class="app-main">
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step completed" data-step="1">
        <div class="step-dot"><i class="fas fa-check" style="font-size:14px"></i></div>
        <span class="step-label">Configure</span>
        <div class="step-line"></div>
      </div>
      <div class="step active" data-step="2">
        <div class="step-dot">2</div>
        <span class="step-label">Upload</span>
        <div class="step-line"></div>
      </div>
      <div class="step" data-step="3">
        <div class="step-dot">3</div>
        <span class="step-label">Review</span>
        <div class="step-line"></div>
      </div>
      <div class="step" data-step="4">
        <div class="step-dot">4</div>
        <span class="step-label">Run</span>
      </div>
    </div>

    <div class="card p-16 fade-in" id="uploadSection">
      <div class="flex justify-between items-center mb-16">
        <div>
          <h1 class="mb-4">Upload <span>Videos</span></h1>
          <p class="text-sm text-gray">Add videos to your dataset for benchmarking</p>
        </div>
        <div class="flex gap-8">
          <button class="btn btn-secondary btn-sm"><i class="fas fa-folder-open"></i> Browse Folder</button>
        </div>
      </div>

      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" multiple accept="video/*" style="display:none" onchange="handleFiles(this.files)">
        <div class="icon-box icon-box-lg" style="margin:0 auto 16px"><i class="fas fa-cloud-upload-alt"></i></div>
        <h3 style="font-size:16px;margin-bottom:8px">Drag and drop videos here</h3>
        <p class="text-sm text-gray mb-16">Supports MP4, AVI, MOV, MKV â€¢ No file size limit</p>
        <button class="btn btn-secondary" onclick="event.stopPropagation();document.getElementById('fileInput').click()">
          <i class="fas fa-plus"></i> Select Files
        </button>
      </div>

      <div id="videoContainer" style="display:none">
        <div class="flex justify-between items-center mt-16 mb-8">
          <h4><i class="fas fa-video" style="margin-right:8px"></i> UPLOADED VIDEOS <span class="count" id="videoCount">0</span></h4>
          <button class="btn btn-ghost btn-sm" onclick="clearVideos()"><i class="fas fa-trash"></i> Clear All</button>
        </div>
        <div class="video-grid" id="videoGrid"></div>
      </div>
    </div>

    <!-- Config Summary -->
    <div class="config-summary slide-up" id="configSummary">
      <h4 class="mb-8"><i class="fas fa-clipboard-list" style="margin-right:8px"></i> EXPERIMENT SUMMARY</h4>
      <div class="config-row">
        <span class="label">Name</span>
        <span class="value" id="summaryName">TED_Gesture_Study</span>
      </div>
      <div class="config-row">
        <span class="label">Videos</span>
        <span class="value" id="summaryVideos">0 videos</span>
      </div>
      <div class="config-row">
        <span class="label">Estimators</span>
        <span class="value" id="summaryEstimators">3 selected</span>
      </div>
      <div class="config-row">
        <span class="label">Metrics</span>
        <span class="value" id="summaryMetrics">Velocity, Acceleration, Jerk</span>
      </div>
      <div class="config-row">
        <span class="label">Est. Time</span>
        <span class="value" id="summaryTime">~5 min</span>
      </div>
    </div>

    <!-- CLI Panel -->
    <div class="cli-panel">
      <div class="cli-header">
        <span class="cli-title"><i class="fas fa-terminal" style="margin-right:8px"></i> Equivalent CLI Command</span>
        <button class="btn btn-ghost btn-sm" style="color:#888" onclick="copyCLI()"><i class="fas fa-copy"></i> Copy</button>
      </div>
      <div class="cli-content">
        <code id="cliCommand">docker compose up -e MASKBENCH_CONFIG_FILE=config/ted-gesture.yml</code>
      </div>
    </div>
  </main>
</div>

<!-- Progress Modal -->
<div class="progress-modal" id="progressModal">
  <div class="progress-card">
    <div class="icon-box icon-box-lg" style="margin:0 auto"><i class="fas fa-cog spin"></i></div>
    <h2 style="margin-top:24px;font-weight:400">Running Experiment</h2>
    <p class="text-sm text-gray" id="progressStatus">Initializing pose estimators...</p>
    <div class="progress-bar-lg">
      <div class="fill" id="progressFill" style="width:0%"></div>
    </div>
    <p class="text-sm"><span id="progressPercent">0</span>% complete</p>
    <button class="btn btn-ghost" style="margin-top:16px" onclick="cancelExperiment()"><i class="fas fa-times"></i> Cancel</button>
  </div>
</div>

<script>
// State
let uploadedVideos = [];
let isRunning = false;

// Mock video data
const mockVideos = [
  { name: 'TED_Talk_Gesture_01.mp4', duration: '2:34', size: '156 MB' },
  { name: 'TED_Talk_Gesture_02.mp4', duration: '3:12', size: '198 MB' },
  { name: 'TED_Talk_Gesture_03.mp4', duration: '1:58', size: '124 MB' }
];

// Checkbox card toggle
document.querySelectorAll('.checkbox-card').forEach(card => {
  card.addEventListener('click', (e) => {
    if (e.target.tagName === 'INPUT') return;
    const input = card.querySelector('input');
    input.checked = !input.checked;
    card.classList.toggle('selected', input.checked);
    updateEstimatorCount();
    updateSummary();
  });
});

function updateEstimatorCount() {
  const count = document.querySelectorAll('#estimatorList .checkbox-card.selected').length;
  document.getElementById('estimatorCount').textContent = count;
}

// Drop zone
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});

function handleFiles(files) {
  if (files.length === 0) return;
  
  // Add mock data for demo
  for (let i = 0; i < files.length; i++) {
    uploadedVideos.push({
      name: files[i].name,
      duration: Math.floor(Math.random() * 180 + 60),
      size: (files[i].size / (1024 * 1024)).toFixed(1) + ' MB'
    });
  }
  
  renderVideos();
  updateSummary();
  updateSteps(2);
}

function addDemoVideos() {
  uploadedVideos = [...mockVideos.map(v => ({...v, duration: v.duration}))];
  renderVideos();
  updateSummary();
  updateSteps(2);
}

function renderVideos() {
  const container = document.getElementById('videoContainer');
  const grid = document.getElementById('videoGrid');
  const countEl = document.getElementById('videoCount');
  
  if (uploadedVideos.length === 0) {
    container.style.display = 'none';
    dropZone.classList.remove('has-files');
    return;
  }
  
  container.style.display = 'block';
  dropZone.classList.add('has-files');
  countEl.textContent = uploadedVideos.length;
  
  grid.innerHTML = uploadedVideos.map((v, i) => `
    <div class="video-card slide-up" style="animation-delay:${i * 0.05}s">
      <button class="remove-btn" onclick="removeVideo(${i})"><i class="fas fa-times"></i></button>
      <div class="video-thumb">
        <i class="fas fa-video"></i>
        <span class="duration">${typeof v.duration === 'number' ? formatDuration(v.duration) : v.duration}</span>
      </div>
      <div class="video-info">
        <div class="video-name" title="${v.name}">${v.name}</div>
        <div class="video-meta">${v.size}</div>
      </div>
    </div>
  `).join('') + `
    <div class="video-card" style="border-style:dashed;display:flex;align-items:center;justify-content:center;min-height:120px;cursor:pointer" onclick="document.getElementById('fileInput').click()">
      <div style="text-align:center;color:#999">
        <i class="fas fa-plus" style="font-size:20px;margin-bottom:4px;display:block"></i>
        <span class="text-xs">Add more</span>
      </div>
    </div>
  `;
}

function formatDuration(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2, '0')}`;
}

function removeVideo(index) {
  uploadedVideos.splice(index, 1);
  renderVideos();
  updateSummary();
}

function clearVideos() {
  uploadedVideos = [];
  renderVideos();
  updateSummary();
}

// Dataset change
function handleDatasetChange() {
  const val = document.getElementById('datasetSelect').value;
  const pck = document.getElementById('pckMetric');
  const rmse = document.getElementById('rmseMetric');
  const note = document.getElementById('gtNote');
  
  if (val === 'tragictalkers') {
    pck.classList.add('selected');
    pck.querySelector('input').checked = true;
    rmse.classList.add('selected');
    rmse.querySelector('input').checked = true;
    note.innerHTML = '<i class="fas fa-check-circle" style="color:#2e7d32"></i> Ground truth available';
    note.style.color = '#2e7d32';
    
    // Auto-add demo videos
    uploadedVideos = [
      { name: 'conversation1_t3-cam08.mp4', duration: '4:22', size: '312 MB' },
      { name: 'interactive1_t1-cam06.mp4', duration: '3:45', size: '285 MB' },
      { name: 'monologue_male_t2-cam04.mp4', duration: '2:58', size: '198 MB' }
    ];
    renderVideos();
  } else if (val === 'tedkid') {
    uploadedVideos = [
      { name: 'ted_kid_education_for_all.mp4', duration: '0:10', size: '12 MB' }
    ];
    renderVideos();
    note.innerHTML = '<i class="fas fa-info-circle"></i> PCK/RMSE require ground truth data';
    note.style.color = '#666';
  } else {
    note.innerHTML = '<i class="fas fa-info-circle"></i> PCK/RMSE require ground truth data';
    note.style.color = '#666';
  }
  updateSummary();
}

// Update summary
function updateSummary() {
  document.getElementById('summaryName').textContent = document.getElementById('experimentName').value || 'Unnamed';
  document.getElementById('summaryVideos').textContent = uploadedVideos.length + ' videos';
  
  const estCount = document.querySelectorAll('#estimatorList .checkbox-card.selected').length;
  document.getElementById('summaryEstimators').textContent = estCount + ' selected';
  
  const metrics = [];
  document.querySelectorAll('.sidebar-section .checkbox-card.selected').forEach(card => {
    const text = card.querySelector('.text-sm');
    if (text && ['Velocity', 'Acceleration', 'Jerk', 'PCK', 'RMSE'].includes(text.textContent)) {
      metrics.push(text.textContent);
    }
  });
  document.getElementById('summaryMetrics').textContent = metrics.slice(0, 3).join(', ') + (metrics.length > 3 ? '...' : '');
  
  // Estimate time
  const timePerVideo = estCount * 2; // ~2 min per estimator per video
  const totalTime = uploadedVideos.length * timePerVideo;
  document.getElementById('summaryTime').textContent = totalTime > 0 ? `~${totalTime} min` : '-';
  
  // Update CLI
  const name = document.getElementById('experimentName').value.toLowerCase().replace(/\s+/g, '-') || 'experiment';
  document.getElementById('cliCommand').textContent = `docker compose up -e MASKBENCH_CONFIG_FILE=config/${name}.yml`;
  
  // Enable/disable run button
  document.getElementById('runBtn').disabled = uploadedVideos.length === 0;
}

// Steps
function updateSteps(currentStep) {
  document.querySelectorAll('.step').forEach((step, i) => {
    const stepNum = i + 1;
    step.classList.remove('active', 'completed');
    if (stepNum < currentStep) step.classList.add('completed');
    if (stepNum === currentStep) step.classList.add('active');
  });
}

// Run experiment
function runExperiment() {
  if (uploadedVideos.length === 0) return;
  
  isRunning = true;
  document.getElementById('progressModal').classList.add('visible');
  
  const statuses = [
    'Initializing pose estimators...',
    'Loading YOLOv11-Pose weights...',
    'Processing video 1/' + uploadedVideos.length + '...',
    'Running MediaPipe Pose...',
    'Running OpenPose...',
    'Computing metrics...',
    'Generating plots...',
    'Finalizing results...'
  ];
  
  let progress = 0;
  let statusIndex = 0;
  
  const interval = setInterval(() => {
    if (!isRunning) {
      clearInterval(interval);
      return;
    }
    
    progress += Math.random() * 8 + 2;
    if (progress > 100) progress = 100;
    
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressPercent').textContent = Math.floor(progress);
    
    if (progress > (statusIndex + 1) * (100 / statuses.length) && statusIndex < statuses.length - 1) {
      statusIndex++;
      document.getElementById('progressStatus').textContent = statuses[statusIndex];
    }
    
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        document.getElementById('progressModal').classList.remove('visible');
        // Redirect to results
        alert('Experiment complete! Redirecting to results...');
        // window.location.href = 'maskbench-results.html';
      }, 500);
    }
  }, 300);
}

function cancelExperiment() {
  isRunning = false;
  document.getElementById('progressModal').classList.remove('visible');
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('progressPercent').textContent = '0';
}

function copyCLI() {
  const cmd = document.getElementById('cliCommand').textContent;
  navigator.clipboard.writeText(cmd);
  alert('CLI command copied!');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  updateSummary();
  updateSteps(2);
  
  // Add demo videos button for testing
  setTimeout(() => {
    if (uploadedVideos.length === 0) {
      addDemoVideos();
    }
  }, 500);
});

// Listen for input changes
document.getElementById('experimentName').addEventListener('input', updateSummary);
</script>

</body>
</html>
